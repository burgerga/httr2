<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="httr2">
<title>OAuth • httr2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.7/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.7/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="OAuth">
<meta property="og:description" content="httr2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="httr2.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">httr2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.3.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/httr2.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/wrapping-apis.html">Wrapping APIs</a>
    <a class="dropdown-item" href="../articles/oauth.html">OAuth</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/httr2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>OAuth</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/httr2/blob/HEAD/vignettes/articles/oauth.Rmd" class="external-link"><code>vignettes/articles/oauth.Rmd</code></a></small>
      <div class="d-none name"><code>oauth.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://httr2.r-lib.org">httr2</a></span><span class="op">)</span></span></code></pre></div>
<p>If the API provides access to a website where the user already has an
account (think Twitter, Instagram, Facebook, Google, GitHub, etc), it’s
likely to use OAuth to allow you to authorise on behalf of the user.
OAuth<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Here I’ll only talk about OAuth 2.0 which is the only
version in common use today. OAuth 1.0 is largely only of historical
interest.&lt;/p&gt;"><sup>1</sup></a> is
an authorisation framework that’s designed so that you don’t have to
share your username and password with an app; instead the app asks for
permission to use your account. You’ve almost certainly used this before
on the web; it’s used in most cases where one website wants to use
another website on your behalf.</p>
<p>OAuth is a broad framework that has many many many different variants
which makes it hard to provide generalisable advice. The following
advice draws on my experience working with a number of OAuth using APIs,
but don’t be surprised if you need to do something slightly different
for the API you’re working with.</p>
<div class="section level2">
<h2 id="clients">Clients<a class="anchor" aria-label="anchor" href="#clients"></a>
</h2>
<p>The first step in working with any OAuth API is to create a client.
This involves you registering for a developer account on the API’s
website and creating a new OAuth app. The process varies from API to
API, but at the end of it you’ll get a client id and in most cases a
client secret.</p>
<p>(You’ll definitely need this for testing your package, and you’ll
probably also baked it into your package for the convenience of your
users. Bundling the app is user friendly, but not always possible,
particularly if rate limits are enforced on a per-app rather than
per-user basis. You should always provide some way for the user to
provide their own app.)</p>
<p>If the API provides a way to authenticate your app without the client
secret, you should leave it out of your package. But in most cases,
you’ll need to include the secret in the package. You can use
<code><a href="../reference/obfuscate.html">obfuscate()</a></code> to hide the secret; this is not bulletproof<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;It uses &lt;code&gt;&lt;a href="../reference/secrets.html"&gt;secret_encrypt()&lt;/a&gt;&lt;/code&gt; with a special
encryption key that’s bundled with httr2.&lt;/p&gt;'><sup>2</sup></a>, but in
most cases it’ll be easier to create a new client than try and steal
yours. Additionally, it’s unusual for an OAuth client to be able to do
anything in its own right, so even if someone does steal your secret
there’s not much harm they can do with it.</p>
<p>To obfuscate a secret, call <code><a href="../reference/obfuscate.html">obfuscate()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/obfuscate.html">obfuscate</a></span><span class="op">(</span><span class="st">"secret"</span><span class="op">)</span></span>
<span><span class="co">#&gt; obfuscated("Msi20qfLgp6s6PMxmhrzS5wo09gQ9Q")</span></span></code></pre></div>
<p>Then use the client id from the website along with the obfuscated
secret to create a client. The following code shows a GitHub OAuth app
that I created specifically for this vignette:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">client</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth_client.html">oauth_client</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="st">"28acfec0674bb3da9f38"</span>,</span>
<span>  secret <span class="op">=</span> <span class="fu"><a href="../reference/obfuscate.html">obfuscated</a></span><span class="op">(</span><span class="st">"J9iiGmyelHltyxqrHXW41ZZPZamyUNxSX1_uKnvPeinhhxET_7FfUs2X0LLKotXY2bpgOMoHRCo"</span><span class="op">)</span>,</span>
<span>  token_url <span class="op">=</span> <span class="st">"https://github.com/login/oauth/access_token"</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"hadley-oauth-test"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You need to figure out the <code>token_url</code> from the <a href="https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps" class="external-link">documentation</a>.
I wish I could give good advice about how to find it 😞.</p>
<p>Note that if you print the client the secret is automatically
redacted:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">client</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">&lt;httr2_oauth_client&gt;</span></span></span>
<span><span class="co">#&gt; name: hadley-oauth-test</span></span>
<span><span class="co">#&gt; id: 28acfec0674bb3da9f38</span></span>
<span><span class="co">#&gt; secret: <span style="color: #555555;">&lt;REDACTED&gt;</span></span></span>
<span><span class="co">#&gt; token_url: https://github.com/login/oauth/access_token</span></span>
<span><span class="co">#&gt; auth: oauth_client_req_auth_body</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="flows">Flows<a class="anchor" aria-label="anchor" href="#flows"></a>
</h2>
<p>Once you have a client you need to use it with a
<strong>flow</strong> in order to get a token. OAuth provides a number
of different “flows”, the most common is the “authorisation code” flow,
which is implemented by <code><a href="../reference/req_oauth_auth_code.html">req_oauth_auth_code()</a></code>. You can try
it out by running this code:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">token</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth_flow_auth_code.html">oauth_flow_auth_code</a></span><span class="op">(</span><span class="va">client</span>, auth_url <span class="op">=</span> <span class="st">"https://github.com/login/oauth/authorize"</span><span class="op">)</span></span></code></pre></div>
<p>This flow can’t be used inside a vignette because it’s designed
specifically for interactive use: it will open a webpage on GitHub that
requires you to interactively confirm it’s OK for this app to use your
GitHub account.</p>
<p>Other flows provide different ways of getting the token:</p>
<ul>
<li><p><code><a href="../reference/req_oauth_client_credentials.html">req_oauth_client_credentials()</a></code> is used to allow the
client to perform actions on its own behalf (instead of on behalf of
some other user). This is typically need if you want to support
<strong>service accounts</strong>, which are used in non-interactive
environments.</p></li>
<li><p><code><a href="../reference/req_oauth_device.html">req_oauth_device()</a></code> uses the “device” flow which is
designed for devices like TVs that don’t have an easy way to enter data.
It also works well from the console.</p></li>
<li><p><code><a href="../reference/req_oauth_bearer_jwt.html">req_oauth_bearer_jwt()</a></code> uses a JWT signed by a
private key.</p></li>
<li><p><code><a href="../reference/req_oauth_password.html">req_oauth_password()</a></code> exchanges a user name and
password for an access token.</p></li>
<li><p><code><a href="../reference/req_oauth_refresh.html">req_oauth_refresh()</a></code> works directly with a refresh
token that you already have. It’s useful for testing.</p></li>
</ul>
<p>There’s one historically important OAuth flow that httr2 doesn’t
support: the implicit grant flow. This is now <a href="https://developer.okta.com/blog/2019/05/01/is-the-oauth-implicit-flow-dead" class="external-link">mostly
deprecated</a> and was never a particularly good fit for native
applications because it relies on a technique for returning the access
token that only works inside a web browser.</p>
<p>When wrapping an API, you’ll need to carefully read the documentation
to figure out which flows are available. Typically you’ll want to use
the auth code flow, but if it’s not available you’ll need to carefully
consider the others. An additional wrinkle is that many APIs don’t
implement the flow in exactly the same way as the spec. If your initial
attempt doesn’t work, you’re going to need to do some sleuthing. This is
going to be painful, but unfortunately there’s no way around it. I
recommend using <code><a href="../reference/with_verbosity.html">with_verbosity()</a></code> so you can see exactly
what httr2 is sending to the server. You’ll then need to carefully
compare this to the API documentation and play “spot the
difference”.</p>
</div>
<div class="section level2">
<h2 id="tokens">Tokens<a class="anchor" aria-label="anchor" href="#tokens"></a>
</h2>
<p>The point of a flow is to get a token. You can use
<code><a href="../reference/req_auth_bearer_token.html">req_auth_bearer_token()</a></code> to authorise a request with the
access token stored inside the token object:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.github.com/user"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/req_auth_bearer_token.html">req_auth_bearer_token</a></span><span class="op">(</span><span class="va">token</span><span class="op">$</span><span class="va">access_token</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="va">.</span><span class="op">$</span><span class="va">name</span></span>
<span><span class="co">#&gt; [1] "Hadley Wickham"</span></span></code></pre></div>
<p>However, in most cases you won’t want to do this, but instead allow
httr2 to manage the whole process, by switching from
<code>oauth_flow_{name}</code> to <code>req_oauth_{name}</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.github.com/user"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/req_oauth_auth_code.html">req_oauth_auth_code</a></span><span class="op">(</span><span class="va">client</span>, auth_url <span class="op">=</span> <span class="st">"https://github.com/login/oauth/authorize"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This is important because most APIs provide only a short-lived access
token that needs to be regularly refreshed using a longer-lived refresh
token. httr2 will automatically refresh the token if it’s expired
(i.e. its expiry date is in the past) or if the request errors with a
401 and there’s an <code>invalid_token</code> error in the
<code>WWW-authenticate</code> header.</p>
</div>
<div class="section level2">
<h2 id="caching">Caching<a class="anchor" aria-label="anchor" href="#caching"></a>
</h2>
<p>By default, <code><a href="../reference/req_oauth_auth_code.html">req_oauth_auth_code()</a></code> and friends will cache
the token in memory, so that multiple requests in the same session all
use the same token. In some cases, you may want to save the token so
that it’s automatically used across sessions. This is easy to do (just
set <code>cache_disk = TRUE</code> in
<code><a href="../reference/req_oauth_auth_code.html">req_oauth_auth_code()</a></code>) but you need to carefully consider
the consequences of saving the user’s credentials on disk.</p>
<p>httr2 does the best it can to save these credentials securely. They
are stored in a local cache directory (<code>oauth_cache_path())</code>
that should only be accessible to the current user, and are encrypted so
they will be hard for any package other than httr2 to read. However,
there’s no way to prevent other R code from using httr2 to access them,
so if you do choose to cache tokens, you should inform the user and give
them the ability to opt-out.</p>
<p>You can see which clients have cached tokens by looking in the cache
directory used by httr2:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="../reference/oauth_cache_path.html">oauth_cache_path</a></span><span class="op">(</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; character(0)</span></span></code></pre></div>
<p>httr2 automatically deletes any cached tokens that are older than 30
days whenever it’s loaded. This means that you’ll need to re-auth at
least once a month, but prevents tokens for hanging around on disk long
after you’ve forgotten you created them.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="http://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.rstudio.com" class="external-link"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

  </div></footer>
</body>
</html>
